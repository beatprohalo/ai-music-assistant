<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; font-src 'self' https://fonts.gstatic.com; img-src 'self' data: https:; connect-src 'self' https:; object-src 'none'; base-uri 'self'; form-action 'self';">
    <title>Settings - AI Music Assistant</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üéµ</text></svg>">
    <style>
        body {
            font-family: 'Share Tech Mono', monospace;
            background: #000;
            color: #00ff00;
            margin: 0;
            padding: 20px;
        }
        .settings-container {
            max-width: 800px;
            margin: 0 auto;
        }
        .setting-group {
            margin-bottom: 20px;
            padding: 15px;
            border: 1px solid #00ff00;
            border-radius: 5px;
        }
        .setting-label {
            display: block;
            margin-bottom: 5px;
            color: #00ff00;
        }
        .setting-input {
            width: 100%;
            padding: 8px;
            background: #001100;
            border: 1px solid #00ff00;
            color: #00ff00;
            font-family: inherit;
        }
        .neon-button {
            background: transparent;
            border: 2px solid #00ff00;
            color: #00ff00;
            padding: 10px 20px;
            font-family: inherit;
            cursor: pointer;
            margin: 5px;
        }
        .neon-button:hover {
            background: #00ff0020;
        }
    </style>
</head>
<body>
    <div class="settings-container">
        <h1>AI Music Assistant Settings</h1>
        
        <div class="setting-group">
            <label class="setting-label">Local LLM Enabled</label>
            <input type="checkbox" id="localLlmEnabled" class="setting-input">
        </div>

        <div class="setting-group">
            <label class="setting-label">Local Model API Identifier</label>
            <input type="text" id="localModelId" class="setting-input" placeholder="e.g., google/gemma-3n-e4b" value="google/gemma-3n-e4b">
            <small style="color: #00aa00; font-size: 12px; margin-top: 5px; display: block;">The model identifier used by your local LLM server</small>
        </div>

        <div class="setting-group">
            <label class="setting-label">Local Server Address</label>
            <input type="text" id="localServerAddress" class="setting-input" placeholder="e.g., http://192.168.0.6:1234" value="http://192.168.0.6:1234">
            <small style="color: #00aa00; font-size: 12px; margin-top: 5px; display: block;">The URL where your local LLM server is running</small>
        </div>

        <div class="setting-group">
            <button class="neon-button" id="testLocalConnection" style="margin-bottom: 10px;">Test Local Connection</button>
            <div id="connectionStatus" style="font-size: 12px; margin-top: 5px;"></div>
            <small style="color: #ffaa00; font-size: 11px; margin-top: 5px; display: block;">
                ‚ö†Ô∏è Note: 400 errors are normal if the local LLM server is not running. 
                Make sure your Ollama, LM Studio, or other LLM server is started before testing.
            </small>
        </div>

        <div class="setting-group">
            <label class="setting-label">Cloud LLM Provider</label>
            <select id="cloudLlmProvider" class="setting-input">
                <option value="none">None</option>
                <option value="openai">OpenAI (GPT-4, GPT-3.5)</option>
                <option value="anthropic">Anthropic (Claude)</option>
                <option value="google">Google (Gemini)</option>
            </select>
            <small style="color: #00aa00; font-size: 12px; margin-top: 5px; display: block;">
                Note: This app focuses on music generation and analysis. OpenAI integration provides text-based music suggestions, not image generation (DALL-E).
            </small>
        </div>
        
        <div class="setting-group">
            <label class="setting-label">API Key</label>
            <input type="password" id="apiKey" class="setting-input" placeholder="Enter API key">
        </div>
        
        <div class="setting-group">
            <label class="setting-label">Model Size</label>
            <select id="modelSize" class="setting-input">
                <option value="small">Small</option>
                <option value="medium">Medium</option>
                <option value="large">Large</option>
            </select>
        </div>
        
        <div class="setting-group">
            <label class="setting-label">Temperature</label>
            <input type="range" id="temperature" class="setting-input" min="0" max="1" step="0.1" value="0.7">
            <span id="temperatureValue">0.7</span>
        </div>
        
        <!-- Auto-Naming Settings -->
        <div class="setting-section">
            <h2>üè∑Ô∏è Auto-Naming System</h2>
            
            <div class="setting-group">
                <label class="setting-label">Enable Smart File Naming</label>
                <input type="checkbox" id="autoNamingEnabled" class="setting-input" checked>
                <small style="color: #00aa00; font-size: 12px; margin-top: 5px; display: block;">
                    Automatically generate intelligent filenames based on your prompt and analyzed music patterns
                </small>
            </div>
            
            <div class="setting-group">
                <label class="setting-label">Naming Template</label>
                <select id="autoNamingTemplate" class="setting-input">
                    <option value="simple">Simple (prompt + timestamp)</option>
                    <option value="descriptive" selected>Descriptive (genre + mood + instrument)</option>
                    <option value="analytical">Analytical (key + tempo + technical)</option>
                    <option value="creative">Creative (artistic names)</option>
                    <option value="professional">Professional (industry standard)</option>
                </select>
                <small style="color: #00aa00; font-size: 12px; margin-top: 5px; display: block;">
                    Choose how your files should be automatically named
                </small>
            </div>
            
            <div class="setting-group">
                <label class="setting-label">Show Filename Suggestions</label>
                <input type="checkbox" id="showFilenameSuggestions" class="setting-input" checked>
                <small style="color: #00aa00; font-size: 12px; margin-top: 5px; display: block;">
                    Show a dialog with multiple filename options before saving files
                </small>
            </div>
        </div>
        
        <div class="setting-group">
            <button class="neon-button" id="saveSettings">Save Settings</button>
            <button class="neon-button" id="backToMain">Back to Main</button>
        </div>
    </div>
    
    <script>
        // Settings object to store all configuration
        let settings = {
            localLlmEnabled: false,
            localModelId: 'google/gemma-3n-e4b',
            localServerAddress: 'http://192.168.0.6:1234',
            cloudLlmProvider: 'none',
            apiKey: '',
            modelSize: 'medium',
            temperature: 0.7,
            autoNaming: {
                enabled: true,
                template: 'descriptive',
                showSuggestions: true
            }
        };

        // Load settings when page loads
        async function loadSettings() {
            try {
                if (window.electronAPI && window.electronAPI.invoke) {
                    const savedSettings = await window.electronAPI.invoke('get-settings');
                    if (savedSettings) {
                        settings = { ...settings, ...savedSettings };
                    }
                }
                updateUI();
            } catch (error) {
                console.error('Error loading settings:', error);
                updateUI(); // Still update UI with defaults
            }
        }

        // Update UI elements with current settings
        function updateUI() {
            document.getElementById('localLlmEnabled').checked = settings.localLlmEnabled;
            document.getElementById('localModelId').value = settings.localModelId;
            document.getElementById('localServerAddress').value = settings.localServerAddress;
            document.getElementById('cloudLlmProvider').value = settings.cloudLlmProvider;
            document.getElementById('apiKey').value = settings.apiKey;
            document.getElementById('modelSize').value = settings.modelSize;
            document.getElementById('temperature').value = settings.temperature;
            document.getElementById('temperatureValue').textContent = settings.temperature;
            
            // Auto-naming settings
            if (settings.autoNaming) {
                document.getElementById('autoNamingEnabled').checked = settings.autoNaming.enabled;
                document.getElementById('autoNamingTemplate').value = settings.autoNaming.template;
                document.getElementById('showFilenameSuggestions').checked = settings.autoNaming.showSuggestions;
            }
        }

        // Save settings
        async function saveSettings() {
            try {
                // Update settings object with current form values
                settings.localLlmEnabled = document.getElementById('localLlmEnabled').checked;
                settings.localModelId = document.getElementById('localModelId').value;
                settings.localServerAddress = document.getElementById('localServerAddress').value;
                settings.cloudLlmProvider = document.getElementById('cloudLlmProvider').value;
                settings.apiKey = document.getElementById('apiKey').value;
                settings.modelSize = document.getElementById('modelSize').value;
                settings.temperature = parseFloat(document.getElementById('temperature').value);
                
                // Update auto-naming settings
                settings.autoNaming = {
                    enabled: document.getElementById('autoNamingEnabled').checked,
                    template: document.getElementById('autoNamingTemplate').value,
                    showSuggestions: document.getElementById('showFilenameSuggestions').checked
                };

                if (window.electronAPI && window.electronAPI.invoke) {
                    await window.electronAPI.invoke('save-settings', settings);
                    showStatus('Settings saved successfully!', 'success');
                } else {
                    showStatus('Settings saved locally!', 'success');
                }
            } catch (error) {
                console.error('Error saving settings:', error);
                showStatus('Error saving settings: ' + error.message, 'error');
            }
        }

        // Test local connection
        async function testLocalConnection() {
            const serverAddress = document.getElementById('localServerAddress').value;
            const modelId = document.getElementById('localModelId').value;

            if (!serverAddress) {
                showConnectionStatus('Please enter a server address', 'error');
                return;
            }

            // Validate URL format
            try {
                new URL(serverAddress);
            } catch (e) {
                showConnectionStatus('Invalid server address format', 'error');
                return;
            }

            showConnectionStatus('Testing connection...', 'info');

            try {
                // Test basic connectivity with proper error handling
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 5000);
                
                const response = await fetch(serverAddress + '/health', {
                    method: 'GET',
                    signal: controller.signal,
                    headers: {
                        'Accept': 'application/json',
                        'Content-Type': 'application/json'
                    }
                });
                
                clearTimeout(timeoutId);

                if (response.ok) {
                    showConnectionStatus('‚úÖ Server is reachable!', 'success');
                } else {
                    showConnectionStatus(`‚ö†Ô∏è Server responded with status ${response.status}`, 'warning');
                }
            } catch (error) {
                if (error.name === 'AbortError') {
                    showConnectionStatus('‚è∞ Connection timeout - server may not be running', 'warning');
                } else {
                    try {
                        // Try alternative endpoint with proper error handling
                        const controller2 = new AbortController();
                        const timeoutId2 = setTimeout(() => controller2.abort(), 5000);
                        
                        const response = await fetch(serverAddress + '/v1/models', {
                            method: 'GET',
                            signal: controller2.signal,
                            headers: {
                                'Accept': 'application/json',
                                'Content-Type': 'application/json'
                            }
                        });
                        
                        clearTimeout(timeoutId2);

                        if (response.ok) {
                            showConnectionStatus('‚úÖ Server is reachable!', 'success');
                        } else {
                            showConnectionStatus(`‚ö†Ô∏è Server responded with status ${response.status}`, 'warning');
                        }
                    } catch (secondError) {
                        if (secondError.name === 'AbortError') {
                            showConnectionStatus('‚è∞ Connection timeout - server may not be running', 'warning');
                        } else {
                            showConnectionStatus('‚ùå Cannot connect to server: ' + secondError.message, 'error');
                        }
                    }
                }
            }
        }

        // Show connection status
        function showConnectionStatus(message, type) {
            const statusDiv = document.getElementById('connectionStatus');
            statusDiv.textContent = message;
            statusDiv.style.color = type === 'success' ? '#00ff00' :
                                   type === 'error' ? '#ff0000' :
                                   type === 'warning' ? '#ffaa00' : '#00aaaa';
        }

        // Show general status message
        function showStatus(message, type) {
            // Create a temporary status message
            const statusDiv = document.createElement('div');
            statusDiv.textContent = message;
            statusDiv.style.position = 'fixed';
            statusDiv.style.top = '20px';
            statusDiv.style.right = '20px';
            statusDiv.style.padding = '10px 20px';
            statusDiv.style.backgroundColor = type === 'success' ? '#004400' : '#440000';
            statusDiv.style.color = type === 'success' ? '#00ff00' : '#ff0000';
            statusDiv.style.border = '1px solid ' + (type === 'success' ? '#00ff00' : '#ff0000');
            statusDiv.style.borderRadius = '5px';
            statusDiv.style.zIndex = '1000';

            document.body.appendChild(statusDiv);

            setTimeout(() => {
                document.body.removeChild(statusDiv);
            }, 3000);
        }

        // Event listeners
        document.getElementById('temperature').addEventListener('input', (e) => {
            document.getElementById('temperatureValue').textContent = e.target.value;
        });

        document.getElementById('backToMain').addEventListener('click', () => {
            if (window.electronAPI) {
                window.electronAPI.openMainWindow();
            }
            window.close();
        });

        document.getElementById('saveSettings').addEventListener('click', saveSettings);
        document.getElementById('testLocalConnection').addEventListener('click', testLocalConnection);

        // Load settings when page loads
        document.addEventListener('DOMContentLoaded', loadSettings);
    </script>
</body>
</html>